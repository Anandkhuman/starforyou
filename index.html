<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Title will be dynamically set by JavaScript -->
    <title>Birthday Surprise Generator</title>

    <!-- ======== STYLES ======== -->
    <style>
        /* --- Basic Setup & Typography --- */
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            min-height: 100vh;
            background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%);
            color: #fff;
            text-align: center;
        }

        /* --- STYLES FOR GENERATOR FORM --- */
        #generator-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .form-wrapper {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 25px; /* MODIFIED: Reduced padding for small screens */
            border-radius: 15px;
            backdrop-filter: blur(10px);
            max-width: 500px;
            width: 100%;
        }

        .form-wrapper h1 {
            font-family: 'Playfair Display', serif;
            margin-bottom: 25px;
            font-size: 2rem; /* MODIFIED: Reduced font size for small screens */
            color: #FFD700;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 300;
        }
        
        /* ======== MODIFICATION: Style for file inputs ======== */
        .form-group input[type="file"] {
            width: 100%;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(0, 0, 0, 0.2);
            color: rgba(255, 255, 255, 0.8);
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
        }
        .form-group input[type="file"]::file-selector-button {
            margin-right: 10px;
            border: none;
            background: #FFD700;
            padding: 8px 12px;
            border-radius: 5px;
            color: #1B2735;
            cursor: pointer;
            transition: background .2s ease-in-out;
        }
        .form-group input[type="file"]::file-selector-button:hover {
            background: #ffed4a;
        }
        /* ======================================================= */

        .form-group input,
        .greeting-input,
        .image-input { /* NEW: Added image-input */
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(0, 0, 0, 0.2);
            color: #fff;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
        }

        .form-group input::placeholder,
        .greeting-input::placeholder { /* NEW: Added image-input */
            color: rgba(255, 255, 255, 0.5);
        }
        
        .greeting-input {
            resize: vertical;
            min-height: 100px;
        }

        /* --- NEW: Styles for dynamic input fields and remove button --- */
        .input-wrapper {
            position: relative;
            margin-bottom: 10px; /* Space between multiple inputs */
        }
        #greetings-container .input-wrapper:last-child,
        #images-container .input-wrapper:last-child {
            margin-bottom: 0;
        }
        .remove-btn {
            position: absolute;
            top: 50%;
            right: 12px;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            font-size: 1.5rem;
            font-weight: bold;
            line-height: 1;
            padding: 0 5px;
            cursor: pointer;
            transition: color 0.2s;
            z-index: 2;
        }
        .remove-btn:hover {
            color: #FF6347; /* Reddish color on hover */
        }
        /* --- END NEW --- */
        
        #add-message-btn,
        #add-image-btn { /* NEW: Grouped styles */
            display: inline-block;
            width: auto;
            background: transparent;
            border: 1px dashed rgba(255, 215, 0, 0.6);
            color: rgba(255, 215, 0, 0.8);
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 0.9rem;
            transition: background 0.2s, color 0.2s, border-color 0.2s;
        }

        #add-message-btn:hover,
        #add-image-btn:hover { /* NEW: Grouped styles */
            background: rgba(255, 215, 0, 0.1);
            color: #FFD700;
            border-color: #FFD700;
        }

        button.generate-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            background: #FFD700;
            color: #1B2735;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }

        button.generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }

        /* --- NEW: Styles for Generate Button Animation --- */
        button.generate-btn {
            position: relative;
            overflow: hidden;
            min-height: 52px; /* Ensure button doesn't collapse */
        }

        .btn-text {
            transition: opacity 0.3s ease;
        }

        button.generate-btn.loading .btn-text,
        button.generate-btn.success .btn-text {
            opacity: 0;
        }

        .loader {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 28px;
            height: 28px;
            margin: -14px 0 0 -14px;
            border: 3px solid rgba(27, 39, 53, 0.2);
            border-top-color: #1B2735;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0s 0.3s;
        }

        button.generate-btn.loading .loader {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.3s ease;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .success-checkmark {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: block;
            stroke-width: 3;
            stroke: #1B2735;
            stroke-miterlimit: 10;
            position: absolute;
            top: 50%;
            left: 50%;
            margin: -20px 0 0 -20px;
            opacity: 0;
            visibility: hidden;
            transform: scale(0.8);
            transition: opacity 0.3s ease, visibility 0s 0.3s, transform 0.3s ease;
        }

        button.generate-btn.success .success-checkmark {
            opacity: 1;
            visibility: visible;
            transform: scale(1);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .checkmark-circle {
            stroke-dasharray: 166;
            stroke-dashoffset: 166;
            stroke-width: 3;
            stroke-miterlimit: 10;
            stroke: #1B2735;
            fill: none;
            animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
        }

        .checkmark-tick {
            transform-origin: 50% 50%;
            stroke-dasharray: 48;
            stroke-dashoffset: 48;
            animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
        }

        @keyframes stroke {
            100% {
                stroke-dashoffset: 0;
            }
        }
        /* --- END NEW --- */
        
        #result-container {
            margin-top: 25px;
            text-align: left;
            display: none;
        }
        
        #result-container p {
            margin-bottom: 10px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.95rem;
        }

        .link-wrapper {
            display: flex;
            align-items: center;
            background: rgba(0,0,0,0.4);
            padding: 8px 12px;
            border-radius: 8px;
        }

        #generated-link {
            font-weight: bold;
            color: #98fb98;
            background: none;
            padding: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1;
            margin-right: 10px;
            text-decoration: none;
        }
        #generated-link:hover {
            text-decoration: underline;
        }

        #copy-btn {
            background: transparent;
            border: none;
            padding: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        #copy-btn svg {
            width: 22px;
            height: 22px;
            fill: #FFD700;
            transition: transform 0.2s, fill 0.2s;
        }

        #copy-btn:hover svg {
            fill: #fff;
            transform: scale(1.1);
        }

        #copy-feedback {
            display: block;
            margin-top: 8px;
            font-size: 0.9em;
            color: #98fb98;
            height: 1.2em;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        /* --- STYLES FOR SURPRISE PAGE (MOBILE FIRST) --- */
        #surprise-container { display: none; overflow: hidden; height: 100vh; width: 100vw; position: fixed; top: 0; left: 0; }
        #bg-canvas, #balloon-container, #confetti-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; overflow: hidden; }
        #balloon-container { z-index: 0; }
        #confetti-container { z-index: 99; }
        .balloon { position: absolute; bottom: -200px; width: 80px; height: 100px; border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%; background-size: cover; opacity: 0.8; }
        .balloon::after { content: ''; position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-bottom: 10px solid; }
        .balloon.pink { background-image: radial-gradient(circle at 30% 30%, #ffc0cb, #e75480); } .balloon.pink::after { border-bottom-color: #e75480; } .balloon.blue { background-image: radial-gradient(circle at 30% 30%, #87ceeb, #4682b4); } .balloon.blue::after { border-bottom-color: #4682b4; } .balloon.yellow { background-image: radial-gradient(circle at 30% 30%, #fffacd, #ffd700); } .balloon.yellow::after { border-bottom-color: #ffd700; } .balloon.green { background-image: radial-gradient(circle at 30% 30%, #98fb98, #3cb371); } .balloon.green::after { border-bottom-color: #3cb371; }
        @keyframes floatUp { 0% { transform: translateY(0) rotate(0deg); opacity: 0.8; } 100% { transform: translateY(-150vh) rotate(360deg); opacity: 0; } }
        .confetti { position: absolute; width: 10px; height: 15px; top: -20px; opacity: 0; }
        @keyframes fall { 0% { transform: translateY(0vh) rotateZ(0deg); opacity: 1; } 100% { transform: translateY(110vh) rotateZ(720deg); opacity: 0; } }
        #curtain { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #090A0F; z-index: 100; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        .prompt { font-size: 1.5rem; color: rgba(255, 255, 255, 0.7); }
        .prompt svg { width: 80px; height: 80px; margin-bottom: 20px; fill: #FFD700; animation: pulse 2s infinite ease-in-out; }
        @keyframes pulse { 0%, 100% { transform: scale(1); filter: drop-shadow(0 0 5px #FFD700); } 50% { transform: scale(1.1); filter: drop-shadow(0 0 20px #FFD700); } }
        #birthday-content { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; padding: 20px; position: relative; z-index: 1; visibility: hidden; }
        h1 span.char, h2 span.char { display: inline-block; }
        #birthday-content h1 { font-family: 'Playfair Display', serif; font-size: clamp(3rem, 10vw, 6rem); font-weight: 700; color: #fff; text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px rgba(255, 215, 0, 0.7); margin-bottom: 10px; }
        #birthday-content h2 { font-family: 'Playfair Display', serif; font-size: clamp(1.6rem, 5vw, 3.5rem); color: #FFD700; text-shadow: 0 0 15px #FFD700; margin-bottom: 30px; }
        .image-container { margin: 0 0 30px 0; position: relative; }
        .message { font-size: clamp(1.5rem, 2.7vw, 1.5rem); max-width: 600px; line-height: 1.8; color: rgba(255, 255, 255, 0.85); }
        @keyframes glow-pulse { 0%, 100% { box-shadow: 0 0 15px rgba(255, 215, 0, 0.6), 0 0 25px rgba(255, 215, 0, 0.4); } 50% { box-shadow: 0 0 25px rgba(255, 215, 0, 0.8), 0 0 40px rgba(255, 215, 0, 0.6); } }
        #person-image { width: 200px; height: 200px; border-radius: 50%; object-fit: cover; border: 3px solid #FFD700; animation: glow-pulse 3s infinite ease-in-out; }
        #countdown { margin-top: 40px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .time-box { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.2); padding: 8px; border-radius: 10px; backdrop-filter: blur(5px); min-width: 65px; }
        .time-box span { display: block; font-size: 1.5rem; font-weight: bold; }
        .time-box p { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: rgba(255, 255, 255, 0.7); }
        #message-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #090A0F; z-index: 200; display: none; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        #message-overlay h1 { font-size: 2.5rem; color: #FFD700; }
        #message-overlay p { font-size: 1.1rem; color: rgba(255, 255, 255, 0.8); max-width: 500px; }
        @media (min-width: 481px) {
            .form-wrapper { padding: 40px; } .form-wrapper h1 { font-size: 2.5rem; } #person-image { width: 150px; height: 150px; } #countdown { gap: 20px; } .time-box { min-width: 90px; padding: 15px 20px; } .time-box span { font-size: 2.5rem; } .time-box p { font-size: 0.8rem; }
        }
    </style>
</head>
<body>

    <div id="generator-container">
        <div class="form-wrapper">
            <h1>Create a Birthday Surprise</h1>
            <div class="form-group">
                <label for="name">Birthday Person's Name</label>
                <input type="text" id="name" placeholder="E.g., Priya" required>
            </div>
            <div class="form-group">
                <label for="birthdate">Birthday Date</label>
                <input type="date" id="birthdate" required>
            </div>
            
            <!-- ==== MODIFIED: IMAGE UPLOAD SECTION ==== -->
            <div class="form-group">
                <label>Upload Images</label>
                <div id="images-container">
                    <div class="input-wrapper">
                         <input type="file" class="image-input" accept="image/*" required>
                    </div>
                </div>
                <button type="button" id="add-image-btn">+ Add Another Image</button>
            </div>
            <!-- ================================ -->

            <div class="form-group">
                <label>Your Greeting Messages</label>
                <div id="greetings-container">
                    <div class="input-wrapper">
                         <textarea class="greeting-input" placeholder="Message 1: May your day be as bright as the stars..."></textarea>
                    </div>
                </div>
                <button type="button" id="add-message-btn">+ Add Another Message</button>
            </div>
            
            <button class="generate-btn" onclick="generateLink()">
                <span class="btn-text">Generate Surprise Link</span>
                <div class="loader"></div>
                <svg class="success-checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                    <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
                    <path class="checkmark-tick" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                </svg>
            </button>
            
            <div id="result-container">
                <p>Success! Share this link:</p>
                <div class="link-wrapper">
                    <a id="generated-link" href="#" target="_blank" rel="noopener noreferrer"></a>
                    <button id="copy-btn" title="Copy to clipboard" onclick="copyLinkToClipboard()">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#FFD700"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-5zm0 16H8V7h11v14z"/></svg>
                    </button>
                </div>
                <span id="copy-feedback"></span>
            </div>
        </div>
    </div>

    <div style="position: relative; top: -20px; font-size: 0.85rem; color: rgba(255, 255, 255, 0.5);">
        <p>Inspired by a project from <a href="https://github.com/Anandkhuman" target="_blank" rel="noopener noreferrer" style="color: #FFD700; text-decoration: none;">Anand Khuman</a></p>
    </div>
    
    <div id="surprise-container">
        <div id="curtain">
            <div class="prompt">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                <p>A little star for you... Click it.</p>
            </div>
        </div>
        <canvas id="bg-canvas"></canvas>
        <div id="balloon-container"></div>
        <div id="confetti-container"></div>
        <div id="birthday-content">
            <h1 id="main-heading">Happy Birthday</h1>
            <h2 id="sub-heading">Name</h2>
            <div class="image-container">
                <img id="person-image" src="" alt="A special photo">
            </div>
            <p class="message">Your custom greeting message will appear here.</p>
            <div id="countdown">
                <div class="time-box"> <span id="days">00</span> <p>Days</p> </div>
                <div class="time-box"> <span id="hours">00</span> <p>Hours</p> </div>
                <div class="time-box"> <span id="minutes">00</span> <p>Minutes</p> </div>
                <div class="time-box"> <span id="seconds">00</span> <p>Seconds</p> </div>
            </div>
        </div>
        <audio id="birthday-song" loop>
            <source src="https://github.com/Anandkhuman/song/raw/main/happy-birthday.mp3" type="audio/mpeg">
        </audio>
    </div>

    <div id="message-overlay">
        <h1 id="message-heading"></h1>
        <p id="message-text"></p>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>

    <script>
        // --- 1. FIREBASE SETUP ---
        const firebaseConfig = {
          apiKey: "AIzaSyAjvI_Vl4trHwZAosaGLdEYQ87jJHeGYwc",
          authDomain: "studio-ahutj.firebaseapp.com",
          databaseURL: "https://studio-ahutj-default-rtdb.firebaseio.com",
          projectId: "studio-ahutj",
          storageBucket: "studio-ahutj.firebasestorage.app",
          messagingSenderId: "636752463109",
          appId: "1:636752463109:web:da78d4100720a39a20a36c"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- 2. PAGE ROUTING & EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const nameKey = urlParams.get('name');

            if (nameKey) {
                document.getElementById('generator-container').style.display = 'none';
                document.querySelector('div[style*="position: relative; top: -20px"]').style.display = 'none';
                loadWishData(nameKey);
            } else {
                document.getElementById('surprise-container').style.display = 'none';
                document.getElementById('add-message-btn').addEventListener('click', addMessageBox);
                document.getElementById('add-image-btn').addEventListener('click', addImageBox);
            }
        });
        
        // --- 3. GENERATOR FUNCTIONS ---
        function addMessageBox() {
            const container = document.getElementById('greetings-container');
            const wrapper = document.createElement('div');
            wrapper.className = 'input-wrapper';
            
            const newTextArea = document.createElement('textarea');
            newTextArea.className = 'greeting-input';
            newTextArea.placeholder = `Message ${container.children.length + 1}: Write another special message...`;
            
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'remove-btn';
            removeBtn.innerHTML = '&times;';
            removeBtn.title = 'Remove message';
            removeBtn.onclick = () => wrapper.remove();
            
            wrapper.appendChild(newTextArea);
            wrapper.appendChild(removeBtn);
            container.appendChild(wrapper);
        }

        // ==== MODIFIED: addImageBox for file uploads ====
        function addImageBox() {
            const container = document.getElementById('images-container');
            const wrapper = document.createElement('div');
            wrapper.className = 'input-wrapper';
            
            const newInput = document.createElement('input');
            newInput.type = 'file'; // Changed from 'url' to 'file'
            newInput.className = 'image-input';
            newInput.accept = 'image/*'; // Recommend image files
            newInput.required = true;

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'remove-btn';
            removeBtn.innerHTML = '&times;';
            removeBtn.title = 'Remove image';
            removeBtn.onclick = () => wrapper.remove();

            wrapper.appendChild(newInput);
            wrapper.appendChild(removeBtn);
            container.appendChild(wrapper);
        }

        // Helper function to read a file as a Base64 Data URL
        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        // ==== MODIFIED: generateLink function to handle file uploads ====
        async function generateLink() {
            const generateBtn = document.querySelector('.generate-btn');
            const name = document.getElementById('name').value;
            const birthdate = document.getElementById('birthdate').value;
            
            const imageInputs = document.querySelectorAll('#images-container .image-input');
            const greetingInputs = document.querySelectorAll('#greetings-container .greeting-input');
            const greetings = Array.from(greetingInputs)
                                .map(input => input.value.trim())
                                .filter(value => value);

            if (!name || !birthdate) {
                alert('Please fill in the Name and Birthday Date fields.');
                return;
            }

            const filesToUpload = Array.from(imageInputs)
                                       .filter(input => input.files && input.files.length > 0)
                                       .map(input => input.files[0]);

            if (filesToUpload.length === 0) {
                alert('Please upload at least one image.');
                return;
            }
            
            if (greetings.length === 0) {
                alert('Please write at least one greeting message.');
                return;
            }

            // Start loading animation
            generateBtn.disabled = true;
            generateBtn.classList.add('loading');

            try {
                // Convert all selected files to Base64 Data URLs
                const fileReadPromises = filesToUpload.map(readFileAsDataURL);
                const imageUrls = await Promise.all(fileReadPromises);

                const nameKey = name.trim().toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
                if(!nameKey) {
                    throw new Error('Please enter a valid name.');
                }

                const wishData = {
                    name: name.trim(),
                    birthdate: birthdate,
                    imageUrls: imageUrls, // Store the Base64 data URLs
                    greetings: greetings,
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                };

                await database.ref('wishes/' + nameKey).set(wishData);

                // Success!
                generateBtn.classList.remove('loading');
                generateBtn.classList.add('success');

                const actualUrl = `${window.location.origin}${window.location.pathname}?name=${nameKey}`;
                const resultContainer = document.getElementById('result-container');
                const linkElement = document.getElementById('generated-link');
                
                linkElement.textContent = actualUrl;
                linkElement.href = actualUrl;
                resultContainer.style.display = 'block';

                setTimeout(() => {
                    generateBtn.classList.remove('success');
                    generateBtn.disabled = false;
                }, 2500);

            } catch (error) {
                console.error("Error during link generation:", error);
                alert("An error occurred. Please check the console and try again.");
                // Reset button on error
                generateBtn.classList.remove('loading');
                generateBtn.disabled = false;
            }
        }


        function copyLinkToClipboard() {
            const linkElement = document.getElementById('generated-link');
            const linkToCopy = linkElement.href;
            const feedbackElement = document.getElementById('copy-feedback');
            const copyBtn = document.getElementById('copy-btn');
            
            navigator.clipboard.writeText(linkToCopy).then(() => {
                feedbackElement.textContent = 'Copied to clipboard!';
                feedbackElement.style.opacity = '1';
                const originalIcon = copyBtn.innerHTML;
                copyBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#98fb98"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>`;
                copyBtn.disabled = true;
                
                setTimeout(() => {
                    feedbackElement.style.opacity = '0';
                    copyBtn.innerHTML = originalIcon;
                    copyBtn.disabled = false;
                }, 2000);
            }).catch(err => {
                console.error('Could not copy text: ', err);
            });
        }
        
        // --- 4. SURPRISE PAGE FUNCTIONS ---
        // (No changes needed in this section)
        function showMessage(heading, text) {
            document.getElementById('surprise-container').style.display = 'none';
            const messageOverlay = document.getElementById('message-overlay');
            document.getElementById('message-heading').textContent = heading;
            document.getElementById('message-text').textContent = text;
            messageOverlay.style.display = 'flex';
        }

        function loadWishData(nameKey) {
            const wishRef = database.ref('wishes/' + nameKey);
            wishRef.once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    const twoDaysInMillis = 2 * 24 * 60 * 60 * 1000;
                    if (Date.now() - data.createdAt > twoDaysInMillis) {
                        showMessage('Oh no!', 'This surprise link has expired. Links are only valid for 2 days.');
                        wishRef.remove();
                        return;
                    }
                    populateSurprisePage(data);
                    document.getElementById('surprise-container').style.display = 'block';
                    initializeSurpriseAnimations(data);
                } else {
                    showMessage('Not Found', 'We couldn\'t find a surprise with this link. It might have been deleted or the link is incorrect.');
                }
            }).catch(error => {
                console.error("Firebase read error: ", error);
                showMessage('Error', 'Could not connect to the database. Please check the console for more details.');
            });
        }

        function populateSurprisePage(data) {
            document.title = `A Special Surprise for ${data.name}!`;
            document.getElementById('main-heading').textContent = `Happy Birthday`;
            document.getElementById('sub-heading').textContent = data.name;
            
            const images = data.imageUrls || [];
            if (images.length > 0) {
                document.getElementById('person-image').src = images[0];
            }
            document.getElementById('person-image').alt = `A photo of ${data.name}`;
            
            const messages = data.greetings || [];
            const messageElement = document.querySelector('.message');
            if (messages.length > 0) {
                messageElement.textContent = messages[0];
            } else {
                messageElement.textContent = "Wishing you a day as special as you are!";
            }
        }

        function cycleMessages(messages) {
            const messageElement = document.querySelector('.message');
            let currentIndex = 0;
            function showNextMessage() {
                gsap.to(messageElement, { opacity: 0, y: -15, duration: 0.7, ease: 'power2.in', onComplete: () => {
                    currentIndex = (currentIndex + 1) % messages.length;
                    messageElement.textContent = messages[currentIndex];
                    gsap.fromTo(messageElement, { opacity: 0, y: 15 }, { opacity: 1, y: 0, duration: 0.7, ease: 'power2.out' });
                }});
            }
            setInterval(showNextMessage, 6500);
        }

        function cycleImages(imageUrls) {
            const imageElement = document.getElementById('person-image');
            let currentIndex = 0;
            function showNextImage() {
                gsap.to(imageElement, { opacity: 0, scale: 0.95, duration: 0.7, ease: 'power2.in', onComplete: () => {
                    currentIndex = (currentIndex + 1) % imageUrls.length;
                    imageElement.src = imageUrls[currentIndex];
                    gsap.to(imageElement, { opacity: 1, scale: 1, duration: 0.7, ease: 'power2.out' });
                }});
            }
            setInterval(showNextImage, 8000);
        }

        // --- 5. ANIMATION & INTERACTIVITY LOGIC ---
        // (No changes needed in this section)
        function initializeSurpriseAnimations(data) {
            const birthdayDateString = data.birthdate;
            const greetings = data.greetings || [];
            const imageUrls = data.imageUrls || [];

            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ canvas: document.querySelector('#bg-canvas'), antialias: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            camera.position.setZ(30);
            const particleCount = 5000;
            const positions = new Float32Array(particleCount * 3);
            for (let i = 0; i < particleCount * 3; i++) { positions[i] = (Math.random() - 0.5) * 500; }
            const particlesGeometry = new THREE.BufferGeometry();
            particlesGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            const particlesMaterial = new THREE.PointsMaterial({ size: 0.1, color: 0xffffff, blending: THREE.AdditiveBlending, transparent: true, opacity: 0.7 });
            const starField = new THREE.Points(particlesGeometry, particlesMaterial);
            scene.add(starField);
            function animateStars() { requestAnimationFrame(animateStars); starField.rotation.y += 0.0001; starField.rotation.x += 0.00005; renderer.render(scene, camera); }
            animateStars();
            window.addEventListener('resize', () => { renderer.setSize(window.innerWidth, window.innerHeight); camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); });

            let timerInterval;
            function setupCountdown() {
                const birthday = new Date(birthdayDateString + 'T00:00:00');
                function updateCountdown() {
                    const now = new Date();
                    const diff = birthday - now;
                    if (diff <= 0) {
                        document.getElementById('countdown').innerHTML = "<h2 style='width: 100%; font-size: 1.5rem;'>The day is here! Happy Birthday!</h2>";
                        clearInterval(timerInterval);
                        return;
                    }
                    const d = Math.floor(diff / (1000*60*60*24)), h = Math.floor((diff % (1000*60*60*24))/(1000*60*60)), m = Math.floor((diff % (1000*60*60))/(1000*60)), s = Math.floor((diff % (1000*60))/1000);
                    document.getElementById('days').innerText = String(d).padStart(2,'0'); document.getElementById('hours').innerText = String(h).padStart(2,'0'); document.getElementById('minutes').innerText = String(m).padStart(2,'0'); document.getElementById('seconds').innerText = String(s).padStart(2,'0');
                }
                timerInterval = setInterval(updateCountdown, 1000);
                updateCountdown();
            }
            setupCountdown();

            const balloonContainer = document.getElementById('balloon-container');
            const colors = ['pink', 'blue', 'yellow', 'green'];
            function createBalloon() {
                const balloon = document.createElement('div'); balloon.className = 'balloon ' + colors[Math.floor(Math.random() * colors.length)]; const size = Math.random() * 40 + 60; balloon.style.width = `${size}px`; balloon.style.height = `${size * 1.25}px`; balloon.style.left = `${Math.random() * 100}%`; const duration = Math.random() * 8 + 8; balloon.style.animation = `floatUp ${duration}s linear forwards`; balloonContainer.appendChild(balloon); setTimeout(() => balloon.remove(), duration * 1000);
            }
            
            function launchConfetti() {
                const confettiContainer = document.getElementById('confetti-container'); const confettiCount = 150; const confettiColors = ['#FFD700', '#FF69B4', '#87CEEB', '#98FB98', '#FFFFFF'];
                for (let i = 0; i < confettiCount; i++) {
                    const confetti = document.createElement('div'); confetti.classList.add('confetti'); confetti.style.left = `${Math.random() * 100}vw`; confetti.style.backgroundColor = confettiColors[Math.floor(Math.random() * confettiColors.length)]; confetti.style.transform = `rotateZ(${Math.random() * 360}deg)`; const duration = Math.random() * 3 + 4; const delay = Math.random() * 2; confetti.style.animation = `fall ${duration}s ${delay}s linear forwards`; confettiContainer.appendChild(confetti); setTimeout(() => confetti.remove(), (duration + delay) * 1000);
                }
            }

            function splitTextIntoSpans(selector) {
                const element = document.querySelector(selector); if(element) { const text = element.textContent; const chars = text.split('').map(char => char === ' ' ? `<span class="char">&nbsp;</span>` : `<span class="char">${char}</span>`).join(''); element.innerHTML = chars; return element.querySelectorAll('.char'); } return [];
            }

            const curtain = document.getElementById('curtain');
            const birthdaySong = document.getElementById('birthday-song');
            
            curtain.addEventListener('click', () => {
                birthdaySong.play().catch(e => console.log("Audio play failed, user interaction needed."));
                const h1Chars = splitTextIntoSpans('#main-heading'); const h2Chars = splitTextIntoSpans('#sub-heading'); const tl = gsap.timeline();

                tl.to(curtain, { opacity: 0, duration: 2, ease: 'power2.inOut', onStart: launchConfetti, onComplete: () => { curtain.style.display = 'none'; setInterval(createBalloon, 800); }});
                tl.to('#birthday-content', { autoAlpha: 1, duration: 0.1 }, "-=1.8");
                tl.from(h1Chars, { y: 80, opacity: 0, scale: 1.5, rotationZ: 'random(-180, 180)', duration: 1.5, stagger: 0.03, ease: 'expo.out' }, "-=1.5");
                tl.from(h2Chars, { y: 50, opacity: 0, rotationX: 90, duration: 1, stagger: 0.02, ease: 'power2.out' }, "-=1.2");
                tl.from(['.image-container', '.message', '#countdown'], { scale: 0.5, opacity: 0, duration: 1.2, stagger: 0.2, ease: 'elastic.out(1, 0.75)' }, "-=0.8")
                  .add(() => {
                      if (greetings && greetings.length > 1) { cycleMessages(greetings); }
                      if (imageUrls && imageUrls.length > 1) { cycleImages(imageUrls); }
                  });
            }, { once: true });
        }
    </script>
</body>
</html>
